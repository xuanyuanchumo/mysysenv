# 数据库设计文档

## 1. 概述

Mysysenv 不使用传统数据库，而是使用 JSON 文件存储配置和缓存数据。本文档描述这些 JSON 文件的数据结构。

## 2. 配置文件设计

### 2.1 文件信息
| 项目 | 值 |
|------|-----|
| 文件名 | config.json |
| 位置 | 项目目录/config/config.json 或 打包后 EXE 所在目录/config/config.json |
| 格式 | JSON |

### 2.2 数据结构

```json
{
  "settings": {
    "tool_templates": {
      "python": {
        "tool_root": "D:\\Tools\\Python",
        "mirror_list": [
          "https://www.python.org/ftp/python/",
          "https://mirrors.huaweicloud.com/python/"
        ],
        "version_cmd": "python --version",
        "env_rule": {
          "home_var": "PYTHON_HOME",
          "path_entries": ["", "Scripts"]
        },
        "version_fetch_config": {
          "version_pattern": "href=\"(\\d+\\.\\d+\\.\\d+)/\"",
          "download_url_template": "{mirror}{version}/python-{version}-embed-{arch}.zip",
          "arch_map": {
            "x64": "amd64",
            "x86": "win32"
          }
        }
      },
      "java": {
        "tool_root": "",
        "mirror_list": [
          "https://mirrors.huaweicloud.com/openjdk/"
        ],
        "version_cmd": "java -version",
        "env_rule": {
          "home_var": "JAVA_HOME",
          "path_entries": ["bin"]
        },
        "version_fetch_config": {
          "version_pattern": "href=\"(\\d+(?:\\.\\d+)*)/\"",
          "download_url_template": "{mirror}{version}/openjdk-{version}_windows-x64_bin.zip"
        }
      }
    },
    "cache_expire_time": 86400,
    "request_rate_limit": 10,
    "download_retry_count": 3,
    "download_speed_limit": 0
  },
  "tools": {
    "python": {
      "installed_versions": ["3.11.4", "3.10.12"],
      "current_version": "3.11.4"
    }
  },
  "cache": "C:\\Users\\Username\\AppData\\Roaming\\Mysysenv\\cache.json"
}
```

### 2.3 字段说明

#### 2.3.1 settings（设置）
| 字段 | 类型 | 说明 |
|------|------|------|
| tool_templates | object | 工具模板配置 |
| cache_expire_time | int | 缓存过期时间（秒），默认 86400（24小时） |
| request_rate_limit | int | 请求频率限制（次/秒），默认 10 |
| download_retry_count | int | 下载重试次数，默认 3 |
| download_speed_limit | int | 下载速度限制（字节/秒），0 表示不限制 |

#### 2.3.2 tool_templates（工具模板）
每个工具模板包含以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| tool_root | string | 工具根目录路径 |
| mirror_list | array | 镜像源 URL 列表 |
| version_cmd | string | 版本检测命令 |
| env_rule | object | 环境变量规则 |
| version_fetch_config | object | 版本获取配置 |

#### 2.3.3 env_rule（环境变量规则）
| 字段 | 类型 | 说明 |
|------|------|------|
| home_var | string | HOME 环境变量名称 |
| path_entries | array | 要添加到 PATH 的子目录列表 |

#### 2.3.4 version_fetch_config（版本获取配置）
| 字段 | 类型 | 说明 |
|------|------|------|
| version_pattern | string | 用于解析版本的正则表达式 |
| download_url_template | string | 下载 URL 模板 |
| arch_map | object | 架构映射（可选） |

#### 2.3.5 tools（工具状态）
| 字段 | 类型 | 说明 |
|------|------|------|
| installed_versions | array | 已安装版本列表 |
| current_version | string | 当前使用版本 |

## 3. 缓存文件设计

### 3.1 文件信息
| 项目 | 值 |
|------|-----|
| 文件名 | cache.json |
| 位置 | 项目目录/config/cache.json 或 打包后 EXE 所在目录/config/cache.json |
| 格式 | JSON |

### 3.2 数据结构

```json
{
  "python_versions": {
    "timestamp": 1706784000,
    "versions": [
      {
        "version": "3.12.0",
        "url": "https://..."
      },
      {
        "version": "3.11.4",
        "url": "https://..."
      }
    ]
  },
  "java_versions": {
    "timestamp": 1706784000,
    "versions": [...]
  }
}
```

### 3.3 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| {tool}_versions | object | 工具版本缓存 |
| timestamp | int | 缓存时间戳（Unix 时间） |
| versions | array | 版本列表 |

## 4. 默认配置文件

### 4.1 文件信息
| 项目 | 值 |
|------|-----|
| 文件名 | default_config.json |
| 位置 | 项目目录/config/default_config.json 或 打包后 EXE 所在目录/config/default_config.json |
| 格式 | JSON |

### 4.2 用途
- 当 config.json 不存在时，以此为模板创建
- 用于重置配置

## 5. 目录结构

```
项目目录/
├── config/
│   ├── config.json          # 配置文件
│   ├── cache.json           # 缓存文件
│   └── default_config.json  # 默认配置模板
```

## 6. 数据访问

### 6.1 配置文件访问
- 使用 ConfigManager 类
- 原子保存防止损坏

### 6.2 缓存文件访问
- 使用 ConfigManager 类
- 自动检查缓存过期时间
