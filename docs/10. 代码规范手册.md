# 代码规范手册

## 1. 概述

本文档描述 Mysysenv 项目的代码规范和最佳实践。

## 2. Python 代码规范

### 2.1 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 模块/包名 | 小写，用下划线分隔 | config_manager, utils |
| 类名 | 大驼峰（PascalCase） | ConfigManager, EnvManager |
| 函数/方法名 | 小写，用下划线分隔 | load_config, get_env_var |
| 常量 | 全大写，用下划线分隔 | CONFIG_DIR, DEFAULT_CONFIG |
| 私有变量/方法 | 单下划线前缀 | _config, _load_cache |
| 保护变量/方法 | 无特殊前缀（在 Python 中没有真正的 protected） | - |

### 2.2 代码格式

#### 2.2.1 缩进
- 使用 4 个空格缩进
- 不使用 Tab

#### 2.2.2 行宽
- 最大行宽：120 字符

#### 2.2.3 空行
- 函数之间空 2 行
- 类之间空 2 行
- 类的方法之间空 1 行
- 逻辑相关的代码块之间空 1 行

### 2.3 导入规范

```python
# 标准库导入
import os
import sys
from pathlib import Path
from typing import Optional, List

# 第三方库导入
from PySide6.QtCore import QObject, Signal

# 本地模块导入
from src.utils.logger import get_logger
from src.core.interfaces import IConfigManager
```

- 导入按顺序分组：标准库 → 第三方库 → 本地模块
- 每组之间空 1 行
- 避免使用 `from module import *`

### 2.4 类型提示

```python
from typing import Optional, List, Dict, Any, Callable

def get_env_var(self, name: str) -> Optional[str]:
    pass

def scan_local_versions(self, tool: str) -> List[Dict[str, Any]]:
    pass

def download_version(
    self,
    tool: str,
    version: str,
    progress_callback: Optional[Callable[[int, int], None]] = None
) -> bool:
    pass
```

### 2.5 注释规范

#### 2.5.1 文档字符串（Docstring）

```python
class ConfigManager(IConfigManager):
    """
    配置管理器类。
    
    负责管理应用程序配置的加载、保存、验证和访问。
    实现 IConfigManager 抽象接口。
    """
    
    def load_config(self) -> dict[str, Any]:
        """
        加载配置文件。
        
        如果配置文件不存在，则创建默认配置文件。
        
        返回:
            配置字典
        """
        pass
    
    def save_config(self, config: dict[str, Any] | None = None) -> None:
        """
        保存配置到文件。
        
        参数:
            config: 要保存的配置字典，如果为 None 则保存当前配置
        """
        pass
```

使用 Google 风格的文档字符串。

#### 2.5.2 行内注释

```python
# 好的注释
# 原子保存：先写临时文件，再重命名，防止写入中断导致文件损坏
temp_path = file_path.with_suffix(file_path.suffix + ".tmp")

# 避免无意义的注释
x = x + 1  # x 加 1
```

### 2.6 异常处理

```python
try:
    with open(file_path, "r", encoding="utf-8") as f:
        data = json.load(f)
except FileNotFoundError:
    logger.warning(f"文件不存在: {file_path}")
    return default_data
except json.JSONDecodeError as e:
    logger.error(f"JSON 解析失败: {e}")
    raise ConfigLoadError(f"配置文件格式错误: {e}") from e
except Exception as e:
    logger.error(f"未知错误: {e}")
    raise
```

- 捕获具体的异常类型
- 使用 `from e` 保留异常链
- 记录日志

## 3. QML 代码规范

### 3.1 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| QML 文件名 | 大驼峰 | Main.qml, Sidebar.qml |
| 组件 id | 小驼峰 | mainWindow, sidebar |
| 属性 | 小驼峰 | currentTool, versionList |
| 信号 | 小驼峰 | toolListChanged, errorOccurred |
| 函数 | 小驼峰 | loadToolList, switchVersion |

### 3.2 代码格式

```qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

ApplicationWindow {
    id: mainWindow
    width: 800
    height: 600
    visible: true
    title: qsTr("Mysysenv - 系统环境管理器")
    
    ColumnLayout {
        anchors.fill: parent
        spacing: 10
        
        Label {
            text: qsTr("Hello World")
            font.pixelSize: 24
        }
        
        Button {
            text: qsTr("Click Me")
            onClicked: {
                console.log("Button clicked")
            }
        }
    }
}
```

## 4. 项目结构规范

```
mysysenv/
├── src/
│   ├── core/              # 核心业务逻辑
│   │   ├── __init__.py
│   │   ├── config_manager.py
│   │   ├── env_manager.py
│   │   └── ...
│   ├── ui/                # 用户界面
│   │   ├── __init__.py
│   │   ├── backend.py
│   │   ├── qml/
│   │   └── viewmodels/
│   ├── utils/             # 工具类
│   │   ├── __init__.py
│   │   ├── logger.py
│   │   └── ...
│   ├── cli.py             # 命令行接口
│   └── main.py            # 主入口
├── docs/                  # 文档
└── ...
```

## 5. Git 提交规范

### 5.1 提交信息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 5.2 Type 类型

| 类型 | 说明 |
|------|------|
| feat | 新功能 |
| fix | 修复 bug |
| docs | 文档更新 |
| style | 代码格式调整 |
| refactor | 重构 |
| test | 测试相关 |
| chore | 构建/工具相关 |

### 5.3 示例

```
feat(version): 添加下载重试机制

- 实现自动重试逻辑
- 可配置重试次数
- 添加重试延迟

Closes #123
```

## 6. 最佳实践

### 6.1 错误处理

- 所有公共方法都应该有异常处理
- 记录详细的错误日志
- 给用户友好的错误提示

### 6.2 日志使用

```python
logger.debug("详细调试信息")
logger.info("一般信息")
logger.warning("警告信息")
logger.error("错误信息")
```

### 6.3 性能考虑

- 避免不必要的计算
- 使用缓存减少重复操作
- IO 操作使用异步（如需要）

### 6.4 安全考虑

- 验证所有用户输入
- 避免命令注入
- 敏感信息不要记录到日志
