# 概要设计说明书

## 1. 文档概述

### 1.1 文档目的
本文档描述 Mysysenv 系统的概要设计，包括系统架构、模块划分、接口设计等内容。

### 1.2 参考文档
- 更新需求分析文档.md
- 需求规格说明书.md
- 技术选型方案.md

## 2. 系统架构设计

### 2.1 整体架构
系统采用分层架构设计，分为以下层次：

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                            │
│  ┌───────────────────┐              ┌───────────────────┐  │
│  │   GUI (QML)      │              │   CLI (argparse)  │  │
│  └────────┬──────────┘              └────────┬──────────┘  │
└───────────┼───────────────────────────────────┼──────────────┘
            │                                   │
┌───────────▼───────────────────────────────────▼──────────────┐
│                        业务逻辑层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ ConfigMgr    │  │ VersionMgr   │  │   EnvMgr     │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │ DownloadMgr  │  │RemoteFetcher │                         │
│  └──────────────┘  └──────────────┘                         │
└───────────┬───────────────────────────────────┬──────────────┘
            │                                   │
┌───────────▼───────────────────────────────────▼──────────────┐
│                         工具层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Logger     │  │   Validator  │  │  Permission  │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└───────────┬───────────────────────────────────┬──────────────┘
            │                                   │
┌───────────▼───────────────────────────────────▼──────────────┐
│                         系统层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Registry   │  │   FileSystem │  │   HTTP(S)    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 设计原则
- 单一职责原则：每个模块只负责一个功能
- 开闭原则：对扩展开放，对修改关闭
- 依赖倒置原则：依赖抽象而非具体实现
- 接口隔离原则：定义最小接口

## 3. 模块设计

### 3.1 核心模块（src/core/）

#### 3.1.1 ConfigManager（配置管理器）
- **职责**：管理应用配置的加载、保存、验证
- **主要功能**：
  - 加载配置文件
  - 保存配置文件
  - 验证配置合法性
  - 提供配置访问接口
  - 管理工具模板配置
- **依赖**：无

#### 3.1.2 EnvManager（环境变量管理器）
- **职责**：管理 Windows 系统环境变量
- **主要功能**：
  - 读取/设置/删除环境变量
  - 管理 PATH 环境变量
  - 设置工具环境变量
  - 广播环境变量变更
  - 获取系统版本
- **依赖**：无

#### 3.1.3 VersionManager（版本管理器）
- **职责**：管理工具版本的生命周期
- **主要功能**：
  - 扫描本地已安装版本
  - 获取远程可用版本
  - 下载安装版本
  - 卸载版本
  - 切换版本
- **依赖**：ConfigManager、EnvManager、DownloadManager、RemoteFetcher

#### 3.1.4 DownloadManager（下载管理器）
- **职责**：负责文件下载
- **主要功能**：
  - 下载文件
  - 进度回调
  - 重试机制
  - 速度限制
- **依赖**：无

#### 3.1.5 RemoteFetcher（远程获取器）
- **职责**：从远程获取版本列表
- **主要功能**：
  - 获取远程版本列表
  - 缓存管理
  - 多镜像源支持
- **依赖**：ConfigManager

#### 3.1.6 LocalManager（本地管理器）
- **职责**：管理本地文件系统
- **主要功能**：
  - 扫描本地版本
  - 解压文件
  - 删除版本目录
- **依赖**：无

#### 3.1.7 Interfaces（接口定义）
- **职责**：定义核心模块的抽象接口
- **主要内容**：
  - IConfigManager
  - IEnvManager
  - IVersionManager
- **依赖**：无

### 3.2 UI 模块（src/ui/）

#### 3.2.1 Backend（后端）
- **职责**：连接 QML 前端和 Python 后端
- **主要功能**：
  - 暴露接口给 QML
  - 处理用户交互
  - 数据绑定
- **依赖**：核心模块

#### 3.2.2 QML 界面
- **职责**：呈现用户界面
- **主要组件**：
  - Main.qml：主窗口
  - Sidebar.qml：侧边栏
  - VersionPanel.qml：版本面板
  - ConfigPanel.qml：配置面板
  - 各种对话框组件
- **依赖**：Backend

#### 3.2.3 ViewModels（视图模型）
- **职责**：为 UI 提供数据
- **主要组件**：
  - ToolDataProvider：工具数据提供
  - ConfigDataProvider：配置数据提供
  - AsyncTaskManager：异步任务管理
  - LoggerBridge：日志桥接
- **依赖**：核心模块

### 3.3 工具模块（src/utils/）

#### 3.3.1 Logger（日志）
- **职责**：提供日志记录功能
- **主要功能**：
  - 多级别日志
  - 格式化输出
- **依赖**：无

#### 3.3.2 PermissionManager（权限管理）
- **职责**：管理管理员权限
- **主要功能**：
  - 检测管理员权限
  - 请求管理员权限
- **依赖**：无

#### 3.3.3 InputValidator（输入验证）
- **职责**：验证用户输入
- **主要功能**：
  - 工具名称验证
  - URL 验证
  - 路径验证
- **依赖**：无

#### 3.3.4 其他工具
- Retry：重试机制
- RateLimiter：频率限制
- SpeedLimiter：速度限制
- DownloadHistory：下载历史

### 3.4 CLI 模块（src/cli.py）
- **职责**：提供命令行接口
- **主要功能**：
  - 命令解析
  - 命令执行
- **依赖**：核心模块

### 3.5 主入口（src/main.py）
- **职责**：应用程序入口
- **主要功能**：
  - 权限检测
  - 启动 GUI 或 CLI
- **依赖**：所有模块

## 4. 接口设计

### 4.1 模块间接口
详见接口文档.md

### 4.2 用户接口
- GUI：PySide6 + QML
- CLI：argparse

## 5. 数据设计

### 5.1 配置文件结构
详见数据库设计文档.md

### 5.2 缓存文件结构
详见数据库设计文档.md

## 6. 部署架构

### 6.1 部署方式
- 源码运行
- 打包成 EXE

### 6.2 运行环境
- Windows 7+
- Python 3.14+（源码运行）

## 7. 安全设计

### 7.1 权限管理
- 检测管理员权限
- 自动请求提升权限

### 7.2 数据安全
- 配置文件原子保存
- 输入验证
