# 详细设计说明书

## 1. 文档概述

### 1.1 文档目的
本文档详细描述 Mysysenv 系统各模块的设计与实现细节。

### 1.2 参考文档
- 概要设计说明书.md
- 代码实现

## 2. ConfigManager 详细设计

### 2.1 类定义
```python
class ConfigManager(IConfigManager):
    """配置管理器类"""
```

### 2.2 属性
| 属性 | 类型 | 说明 |
|------|------|------|
| APP_DIR | Path | 应用程序目录 |
| CONFIG_DIR | Path | 配置目录 |
| CONFIG_FILE | Path | 配置文件路径 |
| CACHE_FILE | Path | 缓存文件路径 |
| DEFAULT_CONFIG_PATH | Path | 默认配置文件路径 |
| _config | dict | 配置数据 |
| _cache | dict | 缓存数据 |

### 2.3 核心方法

#### 2.3.1 load_config()
```
功能：加载配置文件
参数：无
返回：配置字典
流程：
  1. 检查配置文件是否存在
  2. 不存在则创建默认配置
  3. 加载配置文件
  4. 验证配置合法性
  5. 处理向后兼容
  6. 加载缓存
```

#### 2.3.2 save_config()
```
功能：保存配置文件
参数：config（可选）
返回：无
流程：
  1. 验证配置合法性
  2. 原子方式写入文件（先写 .tmp，再重命名）
```

#### 2.3.3 _atomic_save_json()
```
功能：原子保存 JSON 数据
参数：file_path, data, indent
返回：无
说明：防止写入中断导致文件损坏
```

### 2.4 配置结构
详见数据库设计文档.md

## 3. EnvManager 详细设计

### 3.1 类定义
```python
class EnvManager(IEnvManager):
    """环境变量管理器类"""
```

### 3.2 常量
| 常量 | 值 | 说明 |
|------|-----|------|
| ENV_KEY_PATH | r"SYSTEM\CurrentControlSet\Control\Session Manager\Environment" | 注册表路径 |
| ENV_KEY_ROOT | HKEY_LOCAL_MACHINE | 注册表根键 |
| WM_SETTINGCHANGE | 0x001A | 消息ID |
| HWND_BROADCAST | 0xFFFF | 广播句柄 |

### 3.3 核心方法

#### 3.3.1 get_env_var()
```
功能：获取环境变量
参数：name
返回：值或 None
流程：
  1. 打开注册表（只读）
  2. 查询环境变量值
  3. 关闭注册表
```

#### 3.3.2 set_env_var()
```
功能：设置环境变量
参数：name, value
返回：bool
流程：
  1. 打开注册表（可写）
  2. 设置环境变量值
  3. 广播变更消息
```

#### 3.3.3 add_to_path()
```
功能：添加 PATH 条目
参数：entry
返回：bool
流程：
  1. 检查条目是否已存在
  2. 不存在则添加
  3. 保存并广播
```

#### 3.3.4 setup_tool_env()
```
功能：设置工具环境变量
参数：tool, home_var, path, path_entries
返回：bool
流程：
  1. 设置 HOME 环境变量
  2. 添加 PATH 条目
```

## 4. VersionManager 详细设计

### 4.1 类定义
```python
class VersionManager:
    """版本管理器类"""
```

### 4.2 核心方法

#### 4.2.1 scan_local_versions()
```
功能：扫描本地已安装版本
参数：tool
返回：版本列表
流程：
  1. 获取工具根目录
  2. 遍历子目录
  3. 识别版本目录
  4. 返回版本列表
```

#### 4.2.2 get_remote_versions()
```
功能：获取远程版本列表
参数：tool
返回：版本列表
流程：
  1. 检查缓存
  2. 缓存有效则使用缓存
  3. 否则调用 RemoteFetcher
  4. 保存缓存
```

#### 4.2.3 download_version()
```
功能：下载并安装版本
参数：tool, version, progress_callback
返回：bool
流程：
  1. 构建下载 URL
  2. 调用 DownloadManager 下载
  3. 解压到工具根目录
  4. 更新配置
```

#### 4.2.4 switch_version()
```
功能：切换版本
参数：tool, version
返回：bool
流程：
  1. 更新配置中的当前版本
  2. 调用 EnvManager 设置环境变量
  3. 保存配置
```

#### 4.2.5 delete_version()
```
功能：卸载版本
参数：tool, version
返回：bool
流程：
  1. 检查是否是当前版本
  2. 删除版本目录
  3. 更新配置
```

## 5. 其他核心模块

### 5.1 DownloadManager
负责文件下载，支持：
- 进度回调
- 重试机制
- 速度限制
- 多镜像源

### 5.2 RemoteFetcher
负责从远程获取版本列表，支持：
- 正则表达式解析
- 缓存管理
- 多镜像源

### 5.3 LocalManager
负责本地文件管理，支持：
- 扫描本地版本
- 解压文件
- 删除目录

## 6. UI 模块设计

### 6.1 Backend
- 继承自 QObject
- 暴露属性和方法给 QML
- 使用信号槽机制

### 6.2 ViewModels
- ToolDataProvider：管理工具列表数据
- ConfigDataProvider：管理配置数据
- AsyncTaskManager：管理异步任务
- LoggerBridge：桥接日志到 UI

## 7. 工具模块设计

### 7.1 Logger
- 封装 Python logging 模块
- 提供统一的日志接口

### 7.2 PermissionManager
- is_admin()：检测管理员权限
- run_as_admin()：请求提升权限

### 7.3 InputValidator
- validate_tool_name()：验证工具名称
- validate_url()：验证 URL
- validate_path()：验证路径

### 7.4 Retry
- 装饰器模式
- 可配置重试次数和延迟

### 7.5 RateLimiter
- 令牌桶算法
- 限制请求频率

### 7.6 SpeedLimiter
- 限制下载速度
- 令牌桶算法

## 8. CLI 模块设计

### 8.1 命令结构
```
mse [options] <command> [args]
```

### 8.2 命令列表
- list：列出版本
- use：切换版本
- install：安装版本
- uninstall：卸载版本
- root：设置根目录
- config：管理配置
- tools：列出工具

### 8.3 命令处理流程
1. 解析参数
2. 获取管理器实例
3. 执行对应操作
4. 输出结果

## 9. 异常处理设计

### 9.1 自定义异常
- ConfigValidationError
- ConfigLoadError
- ConfigSaveError
- EnvManagerError
- RegistryAccessError
- InputValidationError

### 9.2 异常处理策略
- 记录日志
- 友好提示用户
- 提供回滚方案

## 10. 日志设计

### 10.1 日志级别
- DEBUG：详细调试信息
- INFO：一般信息
- WARNING：警告
- ERROR：错误

### 10.2 日志内容
- 时间戳
- 日志级别
- 模块名
- 消息内容
